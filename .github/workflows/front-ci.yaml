name: frontend-ci

on:
  pull_request:
    branches: [develop, main]
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: read

# CI 동시 실행 제어
concurrency:
  group: frontend-ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (20)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      # CI에서는 로컬 훅(Husky) 불필요, 설치 단계에서 비활성화
      - name: Install
        env:
          HUSKY: 0
        run: npm ci

      # PR 품질 게이트(전체 기준)
      - name: Lint
        run: npm run lint

      # 경고만
      - name: Format Check (warn-only)
        continue-on-error: true
        run: npm run format:check

      # 타입 체크 (안했음)
      - name: Typecheck
        run: npm run typecheck --if-present

      # npm audit: warn-only, 경고는 디코로 보냄
      # npm install로 설치되는 라이브러리들에 공개된 보안 취약점이 있는지 검사
      - name: Dependency Audit (warn-only)
        id: audit
        continue-on-error: true
        run: |
          npm audit --audit-level=high --json > audit.json

          node - <<'NODE'
          const fs = require('fs');
          let high = 0, critical = 0;
          try {
            const j = JSON.parse(fs.readFileSync('audit.json', 'utf8'));
            const v = j.vulnerabilities || {};
            high = (v.high && v.high.count) ? v.high.count : 0;
            critical = (v.critical && v.critical.count) ? v.critical.count : 0;
          } catch (e) {}
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `high=${high}\ncritical=${critical}\n`);
          NODE

      - name: Notify Audit (Discord)
        if: steps.audit.outputs.high != '0' || steps.audit.outputs.critical != '0'
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"content\":\"⚠️ **Frontend Audit 경고 (warn-only)**\\nHigh: ${{ steps.audit.outputs.high }} / Critical: ${{ steps.audit.outputs.critical }}\\nRepo: ${{ github.repository }}\\nRef: ${{ github.ref }}\\nActor: ${{ github.actor }}\\nRun: ${RUN_URL}\"}" \
          ${{ secrets.DISCORD_WEBHOOK }}

      - name: Test
        run: npm test --if-present

      - name: Build
        run: npm run build

      - name: Detect build output
        id: out
        run: |
          OUT=""
          [ -d dist ] && OUT="$OUT dist"
          [ -d build ] && OUT="$OUT build"
          [ -d .next ] && OUT="$OUT .next"
          OUT="$(echo $OUT | xargs)"
          echo "paths=$OUT" >> $GITHUB_OUTPUT
          echo "Detected: $OUT"

      - name: Upload Artifact (main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: ${{ steps.out.outputs.paths }}
          if-no-files-found: error
          retention-days: 7

      - name: Notify Failure (Discord)
        if: failure()
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"content\":\"❌ **Frontend CI 실패**\\nRepo: ${{ github.repository }}\\nRef: ${{ github.ref }}\\nActor: ${{ github.actor }}\\nRun: ${RUN_URL}\"}" \
          ${{ secrets.DISCORD_WEBHOOK }}

      - name: Notify Success (Discord)
        if: success()
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"content\":\"✅ **Frontend CI 성공**\\nRepo: ${{ github.repository }}\\nRef: ${{ github.ref }}\\nActor: ${{ github.actor }}\\nRun: ${RUN_URL}\"}" \
          ${{ secrets.DISCORD_WEBHOOK }}