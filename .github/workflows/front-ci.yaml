name: frontend-ci

on:
  # 1) PR이 develop/main으로 들어올 때: 품질 게이트(병합 전 검증)
  pull_request:
    branches: [develop, main]

  # 2) main/develop 브랜치에 push될 때: 테스트용 빌드 + artifact 업로드
  push:
    branches: [main, develop]

  # 3) 필요하면 수동 실행
  workflow_dispatch: {}

permissions:
  contents: read

# 같은 PR/브랜치에서 커밋이 연속으로 올라오면
# 이전 실행을 취소하고 최신 커밋만 검증해서 CI 낭비를 줄임
concurrency:
  group: frontend-ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      # 1. 레포 코드 체크아웃
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Node 20 환경 구성 + npm 캐시 사용
      - name: Setup Node.js (20)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      # 3. 의존성 설치
      - name: Install
        env:
          HUSKY: 0
        run: npm ci

      # 4. ESLint 검사
      - name: Lint
        run: npm run lint

      # 5. Prettier 포맷 체크 (warn-only)
      - name: Format Check (warn-only)
        continue-on-error: true
        run: npm run format:check

      # 6. 타입체크 (있으면)
      - name: Typecheck
        run: npm run typecheck --if-present

      # 7. 의존성 취약점 검사
      - name: Dependency Audit (warn-only)
        id: audit
        continue-on-error: true
        run: |
          npm audit --audit-level=high --json > audit.json
          node - <<'NODE'
          const fs = require('fs');
          let high = 0, critical = 0;
          try {
            const j = JSON.parse(fs.readFileSync('audit.json', 'utf8'));
            const v = j.vulnerabilities || {};
            high = v.high?.count || 0;
            critical = v.critical?.count || 0;
          } catch (e) {}
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `high=${high}\ncritical=${critical}\n`);
          NODE

      # 8. audit 경고 알림
      - name: Notify Audit (Discord)
        if: steps.audit.outputs.high != '0' || steps.audit.outputs.critical != '0'
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"content\":\"⚠️ **Frontend Audit 경고 (warn-only)**\\nHigh: ${{ steps.audit.outputs.high }} / Critical: ${{ steps.audit.outputs.critical }}\\nRepo: ${{ github.repository }}\\nRef: ${{ github.ref }}\\nActor: ${{ github.actor }}\\nRun: ${RUN_URL}\"}" \
          ${{ secrets.DISCORD_WEBHOOK }}

      # 9. 테스트 (있으면)
      - name: Test
        run: npm test --if-present

      # 10. 빌드
      - name: Build
        run: npm run build

      # 11. 빌드 산출물 감지
      - name: Detect build output
        id: out
        run: |
          OUT=""
          [ -d dist ] && OUT="$OUT dist"
          [ -d build ] && OUT="$OUT build"
          [ -d .next ] && OUT="$OUT .next"
          OUT="$(echo $OUT | xargs)"
          echo "paths=$OUT" >> $GITHUB_OUTPUT
          echo "Detected: $OUT"
          if [ -z "$OUT" ]; then
            echo "ERROR: No build output directory found (dist/build/.next)"
            exit 1
          fi

      # 12. artifact 업로드 (main / develop)
      - name: Upload Artifact
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ${{ steps.out.outputs.paths }}
          if-no-files-found: error
          retention-days: 7

      # 13. Discord 알림 (항상)
      - name: Notify Discord (always)
        if: always()
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BRANCH="${{ github.ref_name }}"
          EVENT="${{ github.event_name }}"
          ACTOR="${{ github.actor }}"
          SHA="${{ github.sha }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"

          if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="(커밋 메시지를 이벤트에서 가져올 수 없음)"
          fi

          COMMIT_MSG_ESCAPED="$(printf '%s' "$COMMIT_MSG" | sed 's/\\/\\\\/g; s/\"/\\\"/g')"

          if [ "${{ job.status }}" = "success" ]; then
            STATUS="성공"
            COLOR="65280"
          else
            STATUS="실패"
            COLOR="16711680"
          fi

          curl -X POST -H "Content-Type: application/json" \
          -d "{
            \"embeds\": [{
              \"title\": \"[FE] CI 결과 알림\",
              \"description\": \"**상태**: ${STATUS}\\n**브랜치**: ${BRANCH}\\n**담당자**: ${ACTOR}\",
              \"color\": ${COLOR},
              \"fields\": [
                {\"name\": \"커밋 메시지\", \"value\": \"${COMMIT_MSG_ESCAPED}\"},
                {\"name\": \"로그\", \"value\": \"${RUN_URL}\"}
              ]
            }]
          }" \
          ${{ secrets.DISCORD_WEBHOOK }}
