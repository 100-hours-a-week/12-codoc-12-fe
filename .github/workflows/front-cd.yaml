name: frontend-cd

on:
  workflow_call:
    inputs:
      ref_name:
        description: "Branch name from caller workflow"
        required: true
        type: string
  workflow_dispatch:
    inputs:
      ref_name:
        description: "Branch name to deploy"
        required: true
        type: string

permissions:
  contents: read
  actions: read

concurrency:
  group: frontend-cd-single-ec2
  cancel-in-progress: true

jobs:
  deploy:
    # develop / chore-cicd push 결과만 배포
    if: >
      inputs.ref_name == 'develop'

    runs-on: ubuntu-latest

    steps:
      # 1. CI artifact 다운로드
      - name: Download FE Artifact (from CI run)
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./artifact
          github-token: ${{ github.token }}

      # 2. 다운로드 확인
      - name: List downloaded files
        run: |
          echo "Downloaded artifact:"
          find ./artifact -maxdepth 3 -type f | head -n 200

      # 3. EC2로 업로드
      - name: Upload FE Build Folder to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ inputs.ref_name == 'develop' && secrets.FE_HOST_DEV || secrets.FE_HOST }}
          username: ${{ inputs.ref_name == 'develop' && secrets.DEPLOY_USER_DEV || secrets.DEPLOY_USER }}
          key: ${{ inputs.ref_name == 'develop' && secrets.SSH_PRIVATE_KEY_DEV || secrets.SSH_PRIVATE_KEY }}
          source: 'artifact/**'
          target: '/home/ubuntu/fe/incoming/release'
          strip_components: 1

      # 4. 배포 스크립트 실행
      - name: Execute FE Deploy Script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.ref_name == 'develop' && secrets.FE_HOST_DEV || secrets.FE_HOST }}
          username: ${{ inputs.ref_name == 'develop' && secrets.DEPLOY_USER_DEV || secrets.DEPLOY_USER }}
          key: ${{ inputs.ref_name == 'develop' && secrets.SSH_PRIVATE_KEY_DEV || secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            test -f /home/ubuntu/fe/deploy.sh
            chmod +x /home/ubuntu/fe/deploy.sh
            bash /home/ubuntu/fe/deploy.sh

      # 5. Discord 알림
      - name: Notify Discord
        if: always()
        run: |
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BRANCH="${{ inputs.ref_name }}"
          SHA="${{ github.sha }}"
          ACTOR="${{ github.actor }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"

          if [ "${{ job.status }}" = "success" ]; then
            STATUS="성공"
            COLOR="65280"
          else
            STATUS="실패"
            COLOR="16711680"
          fi

          curl -X POST -H "Content-Type: application/json" \
          -d "{
            \"embeds\": [{
              \"title\": \"[FE] CD 결과 알림\",
              \"description\": \"**상태**: ${STATUS}\\n**브랜치**: ${BRANCH}\\n**담당자**: ${ACTOR}\",
              \"color\": ${COLOR},
              \"fields\": [
                {\"name\": \"커밋 메시지\", \"value\": \"${COMMIT_MSG}\"},
                {\"name\": \"로그\", \"value\": \"${RUN_URL}\"}
              ]
            }]
          }" \
          ${{ secrets.DISCORD_WEBHOOK }}
